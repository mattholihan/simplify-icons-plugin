<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #FFFFFF;
            --color-text: #1E1E1E;
            --color-text-secondary: #666666;
            --color-text-inverse: #F5F5F5;
            --color-border-inactive: #d2d2d2;
            --color-brand: #1E1E1E;
            --color-bg-secondary: #F5F5F5;
            --color-danger: #F24822;
            --color-focus: #725ef6;

            --radius-m: 8px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollable Body */
        .content-scroll {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            padding-bottom: 100px;
            /* Increased to ensure list visibility above fixed button */
            /* Space for floating button */
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }

        p {
            font-size: 16px;
            line-height: 1.5;
            color: var(--color-text);
            margin: 0;
        }

        .label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
        }

        /* Fieldset reset */
        fieldset {
            border: none;
            margin: 0;
            padding: 0;
        }

        legend {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
            padding: 0;
        }

        /* Visually-hidden utility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Radio Cards */
        .radio-group {
            display: flex;
            gap: 8px;
        }

        /* Visually hide radio inputs while keeping them keyboard-accessible */
        .radio-group input[type="radio"] {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .radio-card {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            height: 40px;
            border: 1px solid var(--color-border-inactive);
            border-radius: var(--radius-m);
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
            flex: 1;
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        .radio-card:hover {
            border-color: var(--color-brand);
        }

        .radio-card.active {
            border: 1px solid var(--color-brand);
            box-shadow: inset 0 0 0 1px var(--color-brand);
        }

        /* Focus indicator for radio cards — applied via JS since
           :has() may not be supported in Figma's webview */
        .radio-card.focused {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        .radio-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .radio-text {
            font-size: 16px;
            font-weight: 400;
        }

        /* Input Fields (Hex/Search/Number) */
        input[type="text"],
        input[type="number"] {
            width: 100%;
            height: 40px;
            padding: 0 12px;
            border: 1px solid var(--color-border-inactive);
            border-radius: var(--radius-m);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            background: white;
            color: var(--color-text);
        }

        input[type="text"]:hover,
        input[type="number"]:hover {
            border-color: var(--color-brand);
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border: 1px solid var(--color-brand);
            box-shadow: inset 0 0 0 1px var(--color-brand);
        }

        input[type="text"]:focus-visible,
        input[type="number"]:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        /* Color List */
        .color-list {
            border: 1px solid var(--color-border-inactive);
            border-radius: var(--radius-m);
            background: white;
            margin-top: 12px;
            overflow: hidden;
        }

        .color-group {
            background: var(--color-brand);
            align-content: center;
            height: 40px;
            padding: 0px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-inverse);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .color-item {
            align-content: center;
            height: 40px;
            padding: 0px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-bottom: 1px solid var(--color-bg-secondary);
        }

        .color-item:last-child {
            border-bottom: none;
        }

        .color-item:hover {
            background-color: var(--color-bg-secondary);
        }

        .color-item.selected {
            background-color: #E8E8E8;
            font-weight: 600;
        }

        .color-item:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: -2px;
        }

        .swatch {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .swatch.invalid {
            background: linear-gradient(45deg, transparent 45%, var(--color-danger) 45%, var(--color-danger) 55%, transparent 55%);
            border-color: var(--color-danger);
        }

        /* Content Sections */
        .content-section {
            display: none;
            flex-direction: column;
        }

        .content-section.visible {
            display: flex;
        }

        /* Floating Button Container */
        .floating-action {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 10;
            background-color: var(--color-bg);
            padding: 16px 24px 24px 24px;
            border-top: 1px solid var(--color-border-inactive);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
        }

        #standardizeBtn {
            width: 100%;
            height: 40px;
            background-color: var(--color-brand);
            color: var(--color-text-inverse);
            border: none;
            border-radius: var(--radius-m);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #standardizeBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            transition: transform 0.1s ease;
        }

        #standardizeBtn:active:not(:disabled) {
            transform: translateY(1px);
            transition: transform 0.1s ease;
        }

        #standardizeBtn:disabled {
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border-inactive);
            color: var(--color-text-secondary);
            cursor: not-allowed;
        }

        #standardizeBtn:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        /* Custom Checkbox */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border: 1px solid var(--color-border-inactive);
            border-radius: 4px;
            background-color: var(--color-bg);
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            margin: 0;
        }

        input[type="checkbox"]:checked {
            border-color: var(--color-brand);
            background-color: var(--color-brand);
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='8' viewBox='0 0 10 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 4L3.5 6.5L9 1' stroke='white' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            box-shadow: inset 0 0 0 1px var(--color-brand);
        }

        input[type="checkbox"]:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        /* Toggle Tile */
        .toggle-tile {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            height: 40px;
            border: 1px solid var(--color-border-inactive);
            border-radius: var(--radius-m);
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
            background-color: var(--color-bg);
            color: var(--color-text);
            width: 100%;
            box-sizing: border-box;
        }

        .toggle-tile:hover {
            border-color: var(--color-text);
        }

        /* Active state for Toggle Tile */
        .toggle-tile:has(input:checked) {
            border: 1px solid var(--color-brand);
            box-shadow: inset 0 0 0 1px var(--color-brand);
        }

        /* Focus indicator for Toggle Tile — applied via JS */
        .toggle-tile.focused {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        /* Variable Dropdown UI */
        .size-input-row {
            display: flex;
            gap: 8px;
            position: relative;
            width: 100%;
        }

        .variable-button {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--color-border-inactive);
            border-radius: var(--radius-m);
            cursor: pointer;
            box-shadow: none;
            transition: border-color 0.1s ease;
            font-family: inherit;
        }

        .variable-button:hover {
            border-color: var(--color-brand);
        }

        .variable-button:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        .variable-button svg path {
            stroke: var(--color-text);
        }

        #variable-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            z-index: 99999;
            background: white;
            border: 1px solid var(--color-border-inactive);
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 4px;
        }

        .variable-item {
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
        }

        .variable-item:hover {
            background-color: var(--color-bg-secondary);
        }

        .variable-item:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: -2px;
            background-color: var(--color-bg-secondary);
        }

        .variable-chip-container {
            width: 100%;
            height: 40px;
            border: 1px solid var(--color-border-inactive);
            border-radius: var(--radius-m);
            display: flex;
            align-items: center;
            padding: 0 12px;
            box-sizing: border-box;
            cursor: default;
            justify-content: space-between;
        }

        .chip-clear-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-text-secondary);
            border-radius: 4px;
            transition: all 0.1s ease;
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
        }

        .chip-clear-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--color-text);
        }

        .chip-clear-btn:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <!-- Main Content -->
    <main class="content-scroll">

        <div style="margin-top: 0;">
            <h1>Simplify Icons</h1>
            <p>Declutter icon layers and normalise geometry in a single click.</p>
        </div>

        <!-- Transform & Scale Section -->
        <fieldset>
            <legend>Transform &amp; scale</legend>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; flex-direction: row; gap: 8px;">

                    <label class="toggle-tile">
                        <input type="checkbox" id="outline-checkbox" checked>
                        <span style="font-size: 16px;">Outline stroke</span>
                    </label>

                    <label class="toggle-tile">
                        <input type="checkbox" id="size-checkbox">
                        <span style="font-size: 16px;">Resize icon</span>
                    </label>
                </div>

                <div id="dimensions-input-container" style="display: none;">
                    <div class="size-input-row">
                        <div style="position: relative; width: 100%;">
                            <!-- Manual Mode -->
                            <div id="manual-size-container" style="position: relative; width: 100%;">
                                <label for="size-input" class="sr-only">Icon size in pixels</label>
                                <input type="number" id="size-input" value="24" aria-label="Icon size in pixels"
                                    style="width: 100%; padding-right: 32px;" min="1">
                                <span id="px-suffix" aria-hidden="true"
                                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-secondary); font-size: 14px; pointer-events: none;">px</span>
                            </div>

                            <!-- Variable Mode -->
                            <div id="variable-chip-container" class="variable-chip-container" style="display: none;"
                                role="status" aria-label="Selected size variable">
                                <div
                                    style="display: flex; align-items: center; gap: 8px; flex-grow: 1; overflow: hidden;">
                                    <span id="variable-chip-text"
                                        style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 16px; font-weight: 400;">Variable</span>
                                </div>
                                <button id="variable-chip-clear" class="chip-clear-btn" type="button"
                                    aria-label="Clear selected variable">
                                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none"
                                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                        <path d="M9 3L3 9M3 3L9 9" stroke="currentColor" stroke-width="1.5"
                                            stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <button id="variable-toggle-btn" class="variable-button" type="button"
                            aria-label="Select size variable" aria-haspopup="listbox" aria-expanded="false"
                            aria-controls="variable-dropdown">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                                xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <polygon points="10,2 16.93,5.5 16.93,14.5 10,18 3.07,14.5 3.07,5.5" fill="none"
                                    stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" />
                                <circle cx="10" cy="10" r="2" fill="currentColor" />
                            </svg>
                        </button>

                        <div id="variable-dropdown" role="listbox" aria-label="Size variables">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

            </div>
        </fieldset>

        <!-- Colour Mode Section -->
        <fieldset>
            <legend>Colour mode</legend>
            <div class="radio-group" role="radiogroup" aria-label="Colour mode">
                <!-- Original -->
                <label class="radio-card active" id="card-original">
                    <input type="radio" name="colorMode" value="ORIGINAL" checked>
                    <!-- Unchecked SVG -->
                    <svg class="radio-icon unchecked" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg" style="display:none" aria-hidden="true">
                        <circle cx="12" cy="12" r="11.5" stroke="#B2B2B2" />
                    </svg>
                    <!-- Checked SVG -->
                    <svg class="radio-icon checked" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <circle cx="12" cy="12" r="11.5" stroke="#2C2C2C" />
                        <circle cx="12" cy="12" r="6" fill="#2C2C2C" />
                    </svg>
                    <span class="radio-text">Preserve</span>
                </label>

                <!-- HEX -->
                <label class="radio-card" id="card-hex">
                    <input type="radio" name="colorMode" value="HEX">
                    <svg class="radio-icon unchecked" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <circle cx="12" cy="12" r="11.5" stroke="#B2B2B2" />
                    </svg>
                    <svg class="radio-icon checked" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg" style="display:none" aria-hidden="true">
                        <circle cx="12" cy="12" r="11.5" stroke="#2C2C2C" />
                        <circle cx="12" cy="12" r="6" fill="#2C2C2C" />
                    </svg>
                    <span class="radio-text">HEX</span>
                </label>

                <!-- Styles -->
                <label class="radio-card" id="card-style">
                    <input type="radio" name="colorMode" value="STYLE">
                    <svg class="radio-icon unchecked" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <circle cx="12" cy="12" r="11.5" stroke="#B2B2B2" />
                    </svg>
                    <svg class="radio-icon checked" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg" style="display:none" aria-hidden="true">
                        <circle cx="12" cy="12" r="11.5" stroke="#2C2C2C" />
                        <circle cx="12" cy="12" r="6" fill="#2C2C2C" />
                    </svg>
                    <span class="radio-text">Styles</span>
                </label>
            </div>
        </fieldset>

        <!-- Section: Hex -->
        <div id="section-hex" class="content-section">
            <label for="hexInput" class="label">Custom HEX colour</label>
            <div style="display:flex; gap:8px; align-items:center;">
                <div id="hexPreview" role="img" aria-label="Colour preview: #000000"
                    style="width:40px; height:40px; border-radius:100%; border:1px solid var(--color-border-inactive); background:#000000; flex-shrink:0;">
                </div>
                <div style="position: relative; width: 100%;">
                    <span aria-hidden="true"
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-secondary); font-size: 16px; pointer-events: none;">#</span>
                    <input type="text" id="hexInput" placeholder="000000" value="000000" aria-label="HEX colour value"
                        style="padding-left: 24px; font-family: 'Inter', monospace;">
                </div>
            </div>
        </div>

        <!-- Section: Style -->
        <div id="section-style" class="content-section">
            <label for="searchInput" class="label">Select style or variable</label>
            <input type="text" id="searchInput" placeholder="Search colours..."
                aria-label="Search colour styles and variables">
            <div id="colorList" class="color-list" role="listbox" aria-label="Available colour styles and variables">
                <!-- Populated by JS -->
                <div style="padding:16px; color: var(--color-text-secondary); text-align:center;" role="status">
                    Loading...</div>
            </div>
            <input type="hidden" id="selectedAssetId">
        </div>

    </main>

    <!-- Fixed Footer -->
    <div class="floating-action">
        <div aria-live="polite" aria-atomic="true">
            <button id="standardizeBtn" disabled>Simplify selection (0)</button>
        </div>
    </div>

    <script>
        const btn = document.getElementById('standardizeBtn');
        const colorList = document.getElementById('colorList');
        const searchInput = document.getElementById('searchInput');
        const hexInput = document.getElementById('hexInput');
        const hexPreview = document.getElementById('hexPreview');
        const selectedAssetIdInput = document.getElementById('selectedAssetId');
        const radios = document.getElementsByName('colorMode');

        const sizeCheckbox = document.getElementById('size-checkbox');
        const sizeInput = document.getElementById('size-input');
        const dimensionsContainer = document.getElementById('dimensions-input-container');
        const outlineCheckbox = document.getElementById('outline-checkbox');

        let allAssets = [];
        let selectedAssetId = null;
        let selectedAssetType = null;
        let activeStrategy = 'ORIGINAL';

        const variableToggleBtn = document.getElementById('variable-toggle-btn');
        const variableDropdown = document.getElementById('variable-dropdown');
        const manualSizeContainer = document.getElementById('manual-size-container');
        const variableChipContainer = document.getElementById('variable-chip-container');
        const variableChipText = document.getElementById('variable-chip-text');
        const variableChipClear = document.getElementById('variable-chip-clear');

        let allDimensionVariables = [];
        let selectedDimensionVariableId = null;

        // Helper: update aria-expanded on variable toggle
        function setVariableDropdownOpen(open) {
            variableDropdown.style.display = open ? 'block' : 'none';
            variableToggleBtn.setAttribute('aria-expanded', String(open));
            variableToggleBtn.classList.toggle('active', open);
        }

        // Dimensions Logic
        sizeCheckbox.onchange = () => {
            dimensionsContainer.style.display = sizeCheckbox.checked ? 'block' : 'none';
        };

        // Variable Dropdown Logic
        variableToggleBtn.onclick = (e) => {
            e.stopPropagation(); // Prevent immediate close
            const isVisible = variableDropdown.style.display === 'block';
            setVariableDropdownOpen(!isVisible);
        };

        // Clear Variable Logic
        variableChipClear.onclick = (e) => {
            e.stopPropagation();
            selectDimensionVariable(null);
        };

        // Close dropdown when clicking outside
        window.addEventListener('click', (e) => {
            if (!variableDropdown.contains(e.target) && e.target !== variableToggleBtn && !variableToggleBtn.contains(e.target)) {
                setVariableDropdownOpen(false);
            }
        });

        function populateVariableDropdown() {
            variableDropdown.innerHTML = '';

            if (allDimensionVariables.length === 0) {
                const div = document.createElement('div');
                div.style.padding = "12px";
                div.style.color = "var(--color-text-secondary)";
                div.style.fontSize = "14px";
                div.textContent = "No number variables found";
                div.setAttribute('role', 'option');
                div.setAttribute('aria-disabled', 'true');
                variableDropdown.appendChild(div);
                return;
            }

            // Optional: Add "Detach / Manual" option if a variable is currently selected
            if (selectedDimensionVariableId) {
                const manualItem = document.createElement('div');
                manualItem.className = 'variable-item';
                manualItem.setAttribute('role', 'option');
                manualItem.setAttribute('tabindex', '0');
                manualItem.innerHTML = '<span>Manual Value</span><span>—</span>';
                manualItem.onclick = () => {
                    selectDimensionVariable(null);
                };
                manualItem.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectDimensionVariable(null);
                    }
                };
                variableDropdown.appendChild(manualItem);
            }

            allDimensionVariables.forEach(v => {
                const item = document.createElement('div');
                item.className = 'variable-item';
                item.setAttribute('role', 'option');
                item.setAttribute('tabindex', '0');
                item.innerHTML = `<span>${v.name}</span><span style="color: var(--color-text-secondary);">${v.value}</span>`;
                item.onclick = () => {
                    selectDimensionVariable(v);
                };
                item.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectDimensionVariable(v);
                    }
                };
                variableDropdown.appendChild(item);
            });
        }

        function selectDimensionVariable(variable) {
            if (variable) {
                selectedDimensionVariableId = variable.id;

                // Show Chip Container
                variableChipContainer.style.display = 'flex';
                variableChipText.textContent = variable.name;

                // Hide Manual Input Container
                manualSizeContainer.style.display = 'none';

            } else {
                // Return to Manual
                selectedDimensionVariableId = null;

                // Hide Chip Container
                variableChipContainer.style.display = 'none';

                // Show Manual Input Container
                manualSizeContainer.style.display = 'block';
            }

            setVariableDropdownOpen(false);
        }


        // Initialize Radio Visuals
        function updateRadioVisuals() {
            radios.forEach(r => {
                const card = r.closest('.radio-card');
                const uncheckedIcon = card.querySelector('.unchecked');
                const checkedIcon = card.querySelector('.checked');

                if (r.checked) {
                    card.classList.add('active');
                    uncheckedIcon.style.display = 'none';
                    checkedIcon.style.display = 'block';
                } else {
                    card.classList.remove('active');
                    uncheckedIcon.style.display = 'block';
                    checkedIcon.style.display = 'none';
                }
            });
        }

        // Radio Logic
        radios.forEach(r => {
            r.onchange = () => {
                activeStrategy = r.value;
                updateVisibility();
                updateRadioVisuals();
            };
        });

        function updateVisibility() {
            document.getElementById('section-hex').classList.remove('visible');
            document.getElementById('section-style').classList.remove('visible');

            if (activeStrategy === 'HEX') {
                document.getElementById('section-hex').classList.add('visible');
            } else if (activeStrategy === 'STYLE') {
                document.getElementById('section-style').classList.add('visible');
            }
        }

        // Hex Logic
        hexInput.oninput = () => {
            let val = hexInput.value;
            // Remove hash if user types/pastes it (since we have static prefix)
            val = val.replace(/#/g, '');
            // Filter invalid chars
            val = val.replace(/[^0-9A-Fa-f]/g, '');
            // Limit to 6 chars
            if (val.length > 6) val = val.slice(0, 6);

            hexInput.value = val;

            // Preview
            if (val.length === 3 || val.length === 6) {
                hexPreview.style.background = '#' + val;
                hexPreview.setAttribute('aria-label', 'Colour preview: #' + val);
            }
        };

        // Search Filter
        searchInput.oninput = () => {
            renderList(searchInput.value);
        };

        function renderList(filter = "") {
            colorList.innerHTML = "";
            const term = filter.toLowerCase();

            // Group first
            const groups = {};

            allAssets.forEach(asset => {
                const match = asset.name.toLowerCase().includes(term) || asset.group.toLowerCase().includes(term);
                if (!match) return;

                if (!groups[asset.group]) groups[asset.group] = [];
                groups[asset.group].push(asset);
            });

            if (Object.keys(groups).length === 0) {
                const div = document.createElement('div');
                div.style.padding = "16px";
                div.style.color = "var(--color-text-secondary)";
                div.textContent = "No colors found.";
                div.setAttribute('role', 'status');
                colorList.appendChild(div);
                return;
            }

            for (const groupName in groups) {
                const header = document.createElement('div');
                header.className = 'color-group';
                header.textContent = groupName;
                header.setAttribute('role', 'presentation');
                colorList.appendChild(header);

                groups[groupName].forEach(asset => {
                    const item = document.createElement('div');
                    item.className = 'color-item';
                    item.setAttribute('role', 'option');
                    item.setAttribute('tabindex', '0');
                    item.setAttribute('aria-selected', asset.id === selectedAssetId ? 'true' : 'false');
                    if (asset.id === selectedAssetId) item.classList.add('selected');

                    const swatch = document.createElement('div');
                    swatch.className = 'swatch';
                    swatch.setAttribute('aria-hidden', 'true');

                    if (asset.hex) {
                        swatch.style.backgroundColor = asset.hex;
                    } else {
                        swatch.classList.add('invalid');
                        swatch.title = "Could not resolve color preview";
                    }

                    const name = document.createElement('span');
                    name.textContent = asset.name;

                    item.appendChild(swatch);
                    item.appendChild(name);

                    item.onclick = () => {
                        selectAsset(asset);
                    };

                    item.onkeydown = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            selectAsset(asset);
                        }
                    };

                    colorList.appendChild(item);
                });
            }
        }

        function selectAsset(asset) {
            selectedAssetId = asset.id;
            selectedAssetType = asset.type; // 'STYLE' or 'VARIABLE'
            selectedAssetIdInput.value = asset.id;
            renderList(searchInput.value);
        }

        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;

            if (msg && msg.type === 'selection-updated') {
                if (msg.count > 0) {
                    btn.textContent = `Simplify selection (${msg.count})`;
                    btn.disabled = false;
                } else {
                    btn.textContent = `Nothing selected`;
                    btn.disabled = true;
                }
            }

            if (msg && msg.type === 'color-assets') {
                allAssets = msg.assets;
                renderList();
            }

            if (msg && msg.type === 'dimension-variables') {
                allDimensionVariables = msg.variables;
                populateVariableDropdown();
            }
        };

        btn.onclick = () => {
            let colorValue = null;
            if (activeStrategy === 'HEX') {
                const raw = hexInput.value;
                // Prepend # if missing
                colorValue = raw.startsWith('#') ? raw : '#' + raw;
            }
            if (activeStrategy === 'STYLE') colorValue = selectedAssetId;

            const shouldResize = sizeCheckbox.checked;
            const targetSize = parseInt(sizeInput.value, 10) || 0; // Handle NaN if in text mode (though we pass variableId)
            const shouldOutline = outlineCheckbox.checked;

            parent.postMessage({
                pluginMessage: {
                    type: 'standardize-selection',
                    colorOptions: {
                        mode: activeStrategy,
                        value: colorValue,
                        type: selectedAssetType // 'STYLE' or 'VARIABLE'
                    },
                    shouldResize: shouldResize,
                    targetSize: targetSize,
                    targetSizeVariableId: selectedDimensionVariableId,
                    shouldOutline: shouldOutline
                }
            }, '*');
        }

        // Focus management for radio cards and toggle tiles
        // (JS-based because :has() may not work in Figma's webview)
        document.querySelectorAll('.radio-card input[type="radio"], .toggle-tile input[type="checkbox"]').forEach(input => {
            input.addEventListener('focus', () => {
                input.closest('.radio-card, .toggle-tile').classList.add('focused');
            });
            input.addEventListener('blur', () => {
                input.closest('.radio-card, .toggle-tile').classList.remove('focused');
            });
        });

        // Initial visual state
        updateRadioVisuals();
    </script>
</body>

</html>